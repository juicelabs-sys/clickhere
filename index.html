<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IS THIS KARMA? — Horror 3D</title>

  <style>
    html, body { margin: 0; height: 100%; background:#000; overflow:hidden; }
    canvas { display:block; }

    .hud{
      position: fixed; left: 0; top: 0; right: 0;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding: 10px 12px;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,.78);
      user-select:none;
      pointer-events:auto;
      text-shadow: 0 0 12px rgba(0,0,0,.9);
      z-index: 10;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    .btn{
      cursor:pointer;
      padding:6px 10px; border-radius: 999px;
      background: rgba(255,30,40,.12);
      border: 1px solid rgba(255,30,40,.25);
      color: rgba(255,255,255,.92);
      font-weight: 700;
    }
    .btn:active{ transform: translateY(1px); }
    .small{ opacity:.65; font-size:11px; max-width: 62ch; }

    #errorBox{
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,0,0,.10);
      border: 1px solid rgba(255,0,0,.22);
      color: rgba(255,255,255,.92);
      font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      white-space: pre-wrap;
      display:none;
      z-index: 20;
    }
  </style>

  <!-- Importmap supaya "three" kebaca oleh addons/postprocessing -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>
  <div class="hud">
    <div class="pill">
      <div>
        <div><b>IS THIS KARMA?</b> — realtime horror 3D</div>
        <div class="small">Drag untuk ganggu kamera. Klik <b>Audio</b> untuk ambience.</div>
      </div>
    </div>
    <div class="pill">
      <button id="audioBtn" class="btn" type="button">Audio: OFF</button>
      <div class="small" id="status">Loading font…</div>
    </div>
  </div>

  <div id="errorBox"></div>

  <script type="module">
    import * as THREE from "three";
    import { FontLoader } from "three/addons/loaders/FontLoader.js";
    import { TextGeometry } from "three/addons/geometries/TextGeometry.js";

    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { ShaderPass } from "three/addons/postprocessing/ShaderPass.js";
    import { RGBShiftShader } from "three/addons/shaders/RGBShiftShader.js";
    import { FilmPass } from "three/addons/postprocessing/FilmPass.js";

    const errorBox = document.getElementById("errorBox");
    const statusEl = document.getElementById("status");
    const showError = (msg) => {
      console.error(msg);
      errorBox.style.display = "block";
      errorBox.textContent = String(msg);
      statusEl.textContent = "ERROR (lihat box merah)";
    };
    window.addEventListener("error", (e) => showError("JS Error: " + (e?.message || e)));
    window.addEventListener("unhandledrejection", (e) => showError("Promise Rejection: " + (e?.reason || e)));

    // =========================
    // Renderer
    // =========================
    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.15; // ✅ naikkan biar tidak “mati”
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    // =========================
    // Scene / Camera
    // =========================
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.FogExp2(0x000000, 0.05); // ✅ lebih ringan dulu

    const camera = new THREE.PerspectiveCamera(45, innerWidth / innerHeight, 0.1, 250);
    camera.position.set(0, 2.0, 14);

    // =========================
    // Lights (lebih kelihatan)
    // =========================
    scene.add(new THREE.AmbientLight(0x12121a, 0.45));

    const key = new THREE.SpotLight(0xaad6ff, 65, 120, Math.PI * 0.25, 0.35, 1.25);
    key.position.set(6, 10, 11);
    key.target.position.set(0, 1.1, 0);
    scene.add(key, key.target);

    const back = new THREE.PointLight(0xff1218, 30, 90, 2);
    back.position.set(-6, 2.5, -12);
    scene.add(back);

    const flicker = new THREE.PointLight(0xffcc88, 45, 80, 2);
    flicker.position.set(0, 5.8, 8.5);
    scene.add(flicker);

    // Floor
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(150, 150),
      new THREE.MeshStandardMaterial({ color: 0x0a0a12, metalness: 0.1, roughness: 0.18 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -1.25;
    scene.add(floor);

    // ✅ DEBUG: kotak terang supaya pasti kelihatan kalau render jalan
    const debugBox = new THREE.Mesh(
      new THREE.BoxGeometry(1, 1, 1),
      new THREE.MeshStandardMaterial({ color: 0x00ff88, emissive: 0x00ff88, emissiveIntensity: 2 })
    );
    debugBox.position.set(-4.2, 1.0, 0);
    scene.add(debugBox);

    // =========================
    // Text group + placeholder terang
    // =========================
    const group = new THREE.Group();
    group.position.y = 0.35;
    scene.add(group);

    const placeholder = new THREE.Mesh(
      new THREE.BoxGeometry(7.2, 1.8, 0.5),
      new THREE.MeshStandardMaterial({
        color: 0x11111b,
        metalness: 0.2,
        roughness: 0.35,
        emissive: 0x330008,
        emissiveIntensity: 1.6
      })
    );
    placeholder.position.y = 0.85;
    group.add(placeholder);

    // Fresnel glow (blood rim)
    const fresnelMat = new THREE.ShaderMaterial({
      transparent: true,
      depthWrite: false,
      blending: THREE.AdditiveBlending,
      uniforms: {
        uColor: { value: new THREE.Color(0xff0e12) },
        uPower: { value: 2.25 },
        uIntensity: { value: 1.25 }
      },
      vertexShader: `
        varying vec3 vN;
        varying vec3 vV;
        void main(){
          vec4 mv = modelViewMatrix * vec4(position, 1.0);
          vN = normalize(normalMatrix * normal);
          vV = normalize(-mv.xyz);
          gl_Position = projectionMatrix * mv;
        }
      `,
      fragmentShader: `
        varying vec3 vN;
        varying vec3 vV;
        uniform vec3 uColor;
        uniform float uPower;
        uniform float uIntensity;
        void main(){
          float fres = pow(1.0 - max(dot(vN, vV), 0.0), uPower);
          float a = fres * uIntensity;
          gl_FragColor = vec4(uColor, a);
        }
      `
    });

    // ✅ Font load (ini yang bikin teks muncul)
    const fontURL = "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json";

    new FontLoader().load(
      fontURL,
      (font) => {
        statusEl.textContent = "Font loaded ✅";

        group.remove(placeholder);

        const geo = new TextGeometry("IS THIS KARMA?", {
          font,
          size: 1.25,
          height: 0.40,
          curveSegments: 14,
          bevelEnabled: true,
          bevelThickness: 0.05,
          bevelSize: 0.032,
          bevelSegments: 6,
        });
        geo.center();

        const mat = new THREE.MeshPhysicalMaterial({
          color: 0x0b0b14,
          metalness: 1.0,
          roughness: 0.32,
          clearcoat: 0.25,
          clearcoatRoughness: 0.25,
          emissive: new THREE.Color(0x220007),
          emissiveIntensity: 1.0
        });

        const textMesh = new THREE.Mesh(geo, mat);
        group.add(textMesh);

        const glowMesh = new THREE.Mesh(geo.clone(), fresnelMat);
        glowMesh.scale.set(1.03, 1.03, 1.03);
        group.add(glowMesh);

        group.rotation.set(THREE.MathUtils.degToRad(-2.5), THREE.MathUtils.degToRad(7), THREE.MathUtils.degToRad(1.2));
      },
      undefined,
      (err) => showError("Gagal load font JSON.\nKemungkinan CDN keblok / offline.\n\n" + err)
    );

    // =========================
    // Postprocessing
    // =========================
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));

    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.9, 0.7, 0.25);
    composer.addPass(bloom);

    const rgb = new ShaderPass(RGBShiftShader);
    rgb.uniforms.amount.value = 0.0018;
    composer.addPass(rgb);

    const film = new FilmPass(0.25, 0.35, 720, false);
    composer.addPass(film);

    // =========================
    // Interaction (drag)
    // =========================
    let isDown = false, mx = 0, my = 0;
    addEventListener("pointerdown", (e) => { isDown = true; mx = e.clientX; my = e.clientY; });
    addEventListener("pointerup", () => { isDown = false; });
    addEventListener("pointermove", (e) => {
      if (!isDown) return;
      const dx = (e.clientX - mx) / innerWidth;
      const dy = (e.clientY - my) / innerHeight;
      mx = e.clientX; my = e.clientY;
      camera.position.x += dx * 2.0;
      camera.position.y -= dy * 1.5;
    });

    addEventListener("resize", () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      composer.setSize(innerWidth, innerHeight);
    });

    // =========================
    // Audio (optional) — sama seperti sebelumnya tapi versi simpel
    // =========================
    const audioBtn = document.getElementById("audioBtn");
    let audioOn = false;
    let audioCtx = null, master = null, lp = null, osc = null;

    function startAudio(){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain();
      master.gain.value = 0.0;
      master.connect(audioCtx.destination);

      // noise wind (lebih simple)
      const bufferSize = 2 * audioCtx.sampleRate;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++) data[i] = Math.random() * 2 - 1;

      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.loop = true;

      lp = audioCtx.createBiquadFilter();
      lp.type = "lowpass";
      lp.frequency.value = 600;

      const g1 = audioCtx.createGain();
      g1.gain.value = 0.18;

      src.connect(lp); lp.connect(g1); g1.connect(master);
      src.start();

      osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.value = 44;
      const g2 = audioCtx.createGain();
      g2.gain.value = 0.12;
      osc.connect(g2); g2.connect(master);
      osc.start();

      master.gain.setTargetAtTime(0.75, audioCtx.currentTime, 0.25);
    }

    function stopAudio(){
      if (!audioCtx) return;
      master.gain.setTargetAtTime(0.0, audioCtx.currentTime, 0.2);
      setTimeout(() => { try { audioCtx.close(); } catch {} audioCtx = null; }, 400);
    }

    audioBtn.addEventListener("click", () => {
      audioOn = !audioOn;
      audioBtn.textContent = audioOn ? "Audio: ON" : "Audio: OFF";
      if (audioOn) startAudio(); else stopAudio();
    });

    // =========================
    // Horror loop
    // =========================
    const clock = new THREE.Clock();

    function flickerCurve(t){
      const s1 = Math.sin(t * 9.0) * 0.5 + 0.5;
      const s2 = Math.sin(t * 31.0 + 1.7) * 0.5 + 0.5;
      return (0.25 + 0.75 * (s1 * 0.6 + s2 * 0.4));
    }

    function animate(){
      requestAnimationFrame(animate);
      const t = clock.getElapsedTime();

      // debug box rotate (biar kamu yakin ini jalan)
      debugBox.rotation.y += 0.01;

      const creep = Math.min(1, t / 10);
      camera.position.z = 14 - creep * 5.8;
      camera.lookAt(0, 0.9, 0);

      const f = flickerCurve(t);
      flicker.intensity = 14 + 30 * f;

      // spike sesekali
      const spike = (Math.sin(t * 0.9) > 0.995);
      if (spike) {
        flicker.intensity *= 0.15;
        rgb.uniforms.amount.value = 0.006;
        bloom.strength = 1.4;
      } else {
        rgb.uniforms.amount.value = 0.0018 + (1 - f) * 0.0012;
        bloom.strength = 0.9 + (1 - f) * 0.25;
      }

      // fog “breath”
      scene.fog.density = 0.05 + Math.sin(t * 0.32) * 0.008;

      // audio reacts dikit
      if (audioOn && audioCtx && lp && osc) {
        lp.frequency.setTargetAtTime(520 + (1 - f) * 420, audioCtx.currentTime, 0.08);
        osc.frequency.setTargetAtTime(42 + (1 - f) * 10, audioCtx.currentTime, 0.1);
      }

      composer.render();
    }
    animate();
  </script>
</body>
</html>
